#!/usr/bin/env bash
#
# Finds the nearest package.json walking up parent dirs (npm semantics)
# Prints the engines expression from that file.
# Prints nothing if no file found, or file does not declare engines.

# echo "BOOM $PACKAGE_JSON_PATH" >&2

find_package_json_path() {
  local root="$1"
  while [ -n "$root" ]; do
    if [ -e "${root}/package.json" ]; then
      echo "${root}/package.json"
      exit
    fi
    root="${root%/*}"
  done
}

extract_version_from_package_json() {
  local package_json_path="$1"
  local version_regex='"node":[ \t]*"([^"]*)"'
  [[ $(cat "$package_json_path") =~ $version_regex ]]
  echo "${BASH_REMATCH[1]}"
}

PACKAGE_JSON_PATH=$(find_package_json_path "$PWD")

if [ -e "$PACKAGE_JSON_PATH" ]; then
  extract_version_from_package_json "$PACKAGE_JSON_PATH"
fi
